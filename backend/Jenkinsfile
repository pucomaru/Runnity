pipeline {
  agent any

  environment {
    DOCKERHUB_USERNAME = 'daum0604'
    IMAGE       = "docker.io/${DOCKERHUB_USERNAME}/runnity-llm"

    COMPOSE_DIR  = 'backend/ai'
    COMPOSE_FILE = 'docker-compose.yml'
    DEPLOY_DIR   = 'llm-app'

    // ğŸ”¹ AI ì„œë²„ IPë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì •ì˜
    AI_SERVER_IP = '52.79.235.2'
  }

  options {
    disableConcurrentBuilds()
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        script {
          env.TAG = sh(returnStdout: true, script: "git rev-parse --short=7 HEAD").trim()
          if (!env.TAG) { env.TAG = 'manual' }
          echo "Using TAG: ${env.TAG}"
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        dir("${COMPOSE_DIR}") {
          sh "pwd && ls -al"
          withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKERHUB_TOKEN')]) {
            sh """
              set -euxo pipefail
              echo "\$DOCKERHUB_TOKEN" | docker login -u ${DOCKERHUB_USERNAME} --password-stdin

              docker build -t ${IMAGE}:${env.TAG} -t ${IMAGE}:latest -f Dockerfile .

              docker push ${IMAGE}:${env.TAG}
              docker push ${IMAGE}:latest
              docker logout || true
            """
          }
        }
      }
    }

    stage('Bundle compose') {
      steps {
        dir("${COMPOSE_DIR}") {
          sh '''
            set -euxo pipefail
            mkdir -p deploy_bundle
            cp -f docker-compose.yml deploy_bundle/docker-compose.yml
            tar czf deploy_bundle.tgz -C deploy_bundle .
            ls -al deploy_bundle
          '''
        }

        archiveArtifacts artifacts: "${COMPOSE_DIR}/deploy_bundle.tgz", fingerprint: true, onlyIfSuccessful: true
      }
    }

    // ğŸ”¥ ì—¬ê¸°ë¶€í„°ê°€ í•µì‹¬: Deploy ë‹¨ê³„ ìˆ˜ì •
    stage('Deploy to AI server') {
      steps {
        sshagent (credentials: ['ssh_deploy_key']): {
          withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKERHUB_TOKEN')]) {
            // ì‹±ê¸€ì¿¼íŠ¸ íŠ¸ë¦¬í”Œ('''...''') â†’ Groovyê°€ $ë³€ìˆ˜ ì•ˆ ê±´ë“œë¦¼
            sh '''
              set -euxo pipefail

              # ë²ˆë“¤ íŒŒì¼ ì¡´ì¬ í™•ì¸ (í™˜ê²½ë³€ìˆ˜ COMPOSE_DIR ì‚¬ìš©)
              test -f "$COMPOSE_DIR/deploy_bundle.tgz"

              echo ">> Deploy to AI server: $AI_SERVER_IP"

              # 1) ì„œë²„ì— ë””ë ‰í† ë¦¬ ìƒì„±
              ssh -o StrictHostKeyChecking=no ubuntu@$AI_SERVER_IP "set -eux; mkdir -p ~/$DEPLOY_DIR"

              # 2) ë²ˆë“¤ ì „ì†¡
              scp -o StrictHostKeyChecking=no "$COMPOSE_DIR/deploy_bundle.tgz" ubuntu@$AI_SERVER_IP:~/$DEPLOY_DIR/

              # 3) ì„œë²„ì—ì„œ docker compose ì‹¤í–‰
              ssh -o StrictHostKeyChecking=no ubuntu@$AI_SERVER_IP "
                set -euxo pipefail
                cd ~/$DEPLOY_DIR
                ls -al
                tar xzf deploy_bundle.tgz
                test -f docker-compose.yml

                # env & key íŒŒì¼ ì²´í¬ (ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘” ìƒíƒœì—¬ì•¼ í•¨)
                ls -al .env.ai google-tts-key.json || echo 'âš ï¸  .env.ai ë˜ëŠ” google-tts-key.json ì´ ì—†ìŠµë‹ˆë‹¤.'

                echo \"\$DOCKERHUB_TOKEN\" | docker login -u \$DOCKERHUB_USERNAME --password-stdin

                TAG=\$TAG docker compose pull
                TAG=\$TAG docker compose up -d

                docker logout || true
                docker image prune -f || true
                docker compose ps
              "
            '''
          }
        }
      }
    }
  }
}
