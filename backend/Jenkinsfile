pipeline {
  agent any

  environment {
    DOCKERHUB_USERNAME = 'daum0604'
    IMAGE = "docker.io/${DOCKERHUB_USERNAME}/runnity-websocket"

    // backend/ ÏïÑÎûòÏóê ÏûàÎäî ÏõπÏÜåÏºìÏö© docker-compose.yml ÏÇ¨Ïö©
    COMPOSE_FILE = 'docker-compose.yml'

    // ÏõêÍ≤© ÏÑúÎ≤ÑÏóêÏÑú ÏÇ¨Ïö©Ìï† ÎîîÎ†âÌÜ†Î¶¨ Ïù¥Î¶Ñ (~/websocket-app)
    DEPLOY_DIR = 'websocket-app'
  }

  options {
    disableConcurrentBuilds()
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        script {
          env.TAG = sh(returnStdout: true, script: "git rev-parse --short=7 HEAD").trim()
          if (!env.TAG) { env.TAG = 'manual' }
          echo "Using TAG: ${env.TAG}"
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        // üëâ Dockerfile, docker-compose.yml Ïù¥ ÏûàÎäî ÏúÑÏπò: backend/
        dir('backend') {
          sh "pwd && ls -al"
          withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKERHUB_TOKEN')]) {
            sh """
              set -euxo pipefail
              echo "\$DOCKERHUB_TOKEN" | docker login -u ${DOCKERHUB_USERNAME} --password-stdin

              # backend/Dockerfile Í∏∞Ï§ÄÏúºÎ°ú ÎπåÎìú
              docker build -t ${IMAGE}:${env.TAG} -t ${IMAGE}:latest -f Dockerfile .

              docker push ${IMAGE}:${env.TAG}
              docker push ${IMAGE}:latest
              docker logout || true
            """
          }
        }
      }
    }

    stage('Bundle compose') {
      steps {
        dir('backend') {
          sh """
            set -euxo pipefail
            mkdir -p deploy_bundle

            # backend/${COMPOSE_FILE} -> deploy_bundle/docker-compose.yml Î°ú Î≥µÏÇ¨
            cp -f ${COMPOSE_FILE} deploy_bundle/docker-compose.yml

            # ÌïÑÏöî Ïãú backend/.env ÎèÑ Í∞ôÏù¥ Î≤àÎì§ÎßÅ (ÏóÜÏúºÎ©¥ Î¨¥Ïãú)
            [ -f .env ] && cp -f .env deploy_bundle/ || true

            tar czf deploy_bundle.tgz -C deploy_bundle .
            ls -al deploy_bundle
          """
        }

        // workspace Í∏∞Ï§Ä Í≤ΩÎ°ú Ï£ºÏùò: backend/ ÏïàÏóê ÏûàÏùå
        archiveArtifacts artifacts: 'backend/deploy_bundle.tgz', fingerprint: true, onlyIfSuccessful: true
      }
    }

    stage('Deploy to websocket servers') {
      parallel {
        stage('Deploy 43.203.217.82') {
          steps {
            sshagent (credentials: ['ssh_deploy_key']) {
              withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKERHUB_TOKEN')]) {
                sh """
                  set -euxo pipefail
                  test -f backend/deploy_bundle.tgz

                  ssh -o StrictHostKeyChecking=no ubuntu@43.203.217.82 'set -eux; mkdir -p ~/${DEPLOY_DIR}'
                  scp -o StrictHostKeyChecking=no backend/deploy_bundle.tgz ubuntu@43.203.217.82:~/${DEPLOY_DIR}/

                  ssh -o StrictHostKeyChecking=no ubuntu@43.203.217.82 "
                    set -euxo pipefail
                    cd ~/${DEPLOY_DIR}
                    ls -al
                    tar xzf deploy_bundle.tgz
                    test -f docker-compose.yml

                    echo '\$DOCKERHUB_TOKEN' | docker login -u ${DOCKERHUB_USERNAME} --password-stdin

                    TAG=${env.TAG} docker compose pull
                    TAG=${env.TAG} docker compose up -d

                    docker logout || true
                    docker image prune -f || true
                    docker compose ps
                  "
                """
              }
            }
          }
        }

        stage('Deploy 13.125.163.87') {
          steps {
            sshagent (credentials: ['ssh_deploy_key']) {
              withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKERHUB_TOKEN')]) {
                sh """
                  set -euxo pipefail
                  test -f backend/deploy_bundle.tgz

                  ssh -o StrictHostKeyChecking=no ubuntu@13.125.163.87 'set -eux; mkdir -p ~/${DEPLOY_DIR}'
                  scp -o StrictHostKeyChecking=no backend/deploy_bundle.tgz ubuntu@13.125.163.87:~/${DEPLOY_DIR}/

                  ssh -o StrictHostKeyChecking=no ubuntu@13.125.163.87 "
                    set -euxo pipefail
                    cd ~/${DEPLOY_DIR}
                    ls -al
                    tar xzf deploy_bundle.tgz
                    test -f docker-compose.yml

                    echo '\$DOCKERHUB_TOKEN' | docker login -u ${DOCKERHUB_USERNAME} --password-stdin

                    TAG=${env.TAG} docker compose pull
                    TAG=${env.TAG} docker compose up -d

                    docker logout || true
                    docker image prune -f || true
                    docker compose ps
                  "
                """
              }
            }
          }
        }
      }
    }
  }
}
