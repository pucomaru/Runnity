pipeline {
  agent any

  environment {
    DOCKERHUB_USERNAME = 'daum0604'
    IMAGE = "docker.io/${DOCKERHUB_USERNAME}/runnity-stream"
  }

  options { disableConcurrentBuilds(); timestamps() }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        script {
          env.TAG = sh(returnStdout: true, script: "git rev-parse --short=7 HEAD").trim()
          if (!env.TAG) { env.TAG = 'manual' }
          echo "Using TAG: ${env.TAG}"
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        // ⬇️ stream이 아닌 backend 경로에서 빌드 (Dockerfile이 여기 있음)
        dir('backend') {
          sh "pwd && ls -al"
          withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKERHUB_TOKEN')]) {
            sh """
              set -euxo pipefail
              echo "\$DOCKERHUB_TOKEN" | docker login -u ${DOCKERHUB_USERNAME} --password-stdin
              # 필요시 --build-arg MODULE=stream 같은 인자도 전달 가능
              docker build -t ${IMAGE}:${env.TAG} -t ${IMAGE}:latest -f Dockerfile .
              docker push ${IMAGE}:${env.TAG}
              docker push ${IMAGE}:latest
              docker logout || true
            """
          }
        }
      }
    }

    stage('Bundle compose') {
      steps {
        // ⬇️ compose도 backend 폴더에 있다고 가정
        dir('backend') {
          sh """
            set -euxo pipefail
            mkdir -p deploy_bundle
            # stream 전용 compose 파일이 따로 있으면 이름 맞춰서 복사
            # cp -f docker-compose.stream.yml deploy_bundle/docker-compose.yml
            cp -f docker-compose.yml deploy_bundle/
            [ -f .env ] && cp -f .env deploy_bundle/ || true
            tar czf deploy_bundle.tgz -C deploy_bundle .
            ls -al deploy_bundle
          """
        }
        archiveArtifacts artifacts: 'backend/deploy_bundle.tgz', fingerprint: true, onlyIfSuccessful: true
      }
    }

    stage('Deploy to stream server') {
      steps {
        sshagent (credentials: ['ssh_deploy_key']) {
          withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKERHUB_TOKEN')]) {
            sh """
              set -euxo pipefail
              test -f backend/deploy_bundle.tgz

              ssh -o StrictHostKeyChecking=no ubuntu@43.203.250.119 'set -eux; mkdir -p ~/stream-app'
              scp -o StrictHostKeyChecking=no backend/deploy_bundle.tgz ubuntu@43.203.250.119:~/stream-app/

              ssh -o StrictHostKeyChecking=no ubuntu@43.203.250.119 "set -euxo pipefail; cd ~/stream-app; ls -al; tar xzf deploy_bundle.tgz; test -f docker-compose.yml; echo '\$DOCKERHUB_TOKEN' | docker login -u ${DOCKERHUB_USERNAME} --password-stdin; TAG=${env.TAG} docker compose pull; TAG=${env.TAG} docker compose up -d; docker logout || true; docker system prune -af --volumes || true; docker compose ps"
            """
          }
        }
      }
    }
  }
}
