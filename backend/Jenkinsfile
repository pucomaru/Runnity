pipeline {
  agent any

  environment {
    DOCKERHUB_USERNAME = 'daum0604'
    IMAGE = "docker.io/${DOCKERHUB_USERNAME}/runnity-llm"
  }

  options {
    disableConcurrentBuilds()
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        script {
          env.TAG = sh(returnStdout: true, script: "git rev-parse --short=7 HEAD").trim()
          if (!env.TAG) { env.TAG = 'manual' }
          echo "Using TAG: ${env.TAG}"
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        // ğŸ“‚ ë°±ì—”ë“œ: dir('backend') / AI: dir('backend/ai')
        dir('backend/ai') {
          sh "pwd && ls -al"
          withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKERHUB_TOKEN')]) {
            sh """
              set -euxo pipefail
              echo "\$DOCKERHUB_TOKEN" | docker login -u ${DOCKERHUB_USERNAME} --password-stdin

              docker build -t ${IMAGE}:${env.TAG} -t ${IMAGE}:latest -f Dockerfile .

              docker push ${IMAGE}:${env.TAG}
              docker push ${IMAGE}:latest
              docker logout || true
            """
          }
        }
      }
    }

    stage('Bundle compose') {
      steps {
        // ğŸ“‚ backend/ai ì•ˆì—ì„œ ë²ˆë“¤ ìƒì„±
        dir('backend/ai') {
          sh """
            set -euxo pipefail
            mkdir -p deploy_bundle
            cp -f docker-compose.yml deploy_bundle/
            # .env.ai, google-tts-key.json ì€ ì„œë²„ì—ë§Œ ìˆê³  ë²ˆë“¤ì—ëŠ” í¬í•¨ ì•ˆ í•¨
            tar czf deploy_bundle.tgz -C deploy_bundle .
            ls -al deploy_bundle
          """
        }

        // workspace ê¸°ì¤€: backend/ai/deploy_bundle.tgz
        archiveArtifacts artifacts: 'backend/ai/deploy_bundle.tgz', fingerprint: true, onlyIfSuccessful: true
      }
    }
    stage('Deploy to AI server') {
        steps {
            sshagent (credentials: ['ssh_deploy_key']) {
            withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKERHUB_TOKEN')]) {
                sh """
                set -euxo pipefail

                # ë²ˆë“¤ íŒŒì¼ ì¡´ì¬ í™•ì¸
                test -f backend/ai/deploy_bundle.tgz

                # 1) ì„œë²„ì— ë””ë ‰í† ë¦¬ ìƒì„±
                ssh -o StrictHostKeyChecking=no ubuntu@52.79.235.2 'set -eux; mkdir -p ~/llm-app'

                # 2) ë²ˆë“¤ ì „ì†¡
                scp -o StrictHostKeyChecking=no backend/ai/deploy_bundle.tgz ubuntu@52.79.235.2:~/llm-app/

                # 3) ì›ê²© ì„œë²„ì—ì„œ docker-compose ì‹¤í–‰
                ssh -o StrictHostKeyChecking=no ubuntu@52.79.235.2 "set -euxo pipefail; \
                    cd ~/llm-app; \
                    ls -al; \
                    tar xzf deploy_bundle.tgz; \
                    test -f docker-compose.yml; \
                    # env & key íŒŒì¼ ì²´í¬
                    ls -al .env.ai google-tts-key.json || echo 'âš ï¸  .env.ai ë˜ëŠ” google-tts-key.json ì´ ì—†ìŠµë‹ˆë‹¤.'; \
                    # .env.ai â†’ í™˜ê²½ë³€ìˆ˜ë¡œ export (compose ë³€ìˆ˜ ì¹˜í™˜ìš©)
                    set -a; [ -f .env.ai ] && . .env.ai; set +a; \
                    echo '\$DOCKERHUB_TOKEN' | docker login -u ${DOCKERHUB_USERNAME} --password-stdin; \
                    TAG=${env.TAG} docker compose pull; \
                    TAG=${env.TAG} docker compose up -d; \
                    docker logout || true; \
                    docker image prune -f || true; \
                    docker compose ps \
                "
                """
            }
            }
        }
    }

  }
}
