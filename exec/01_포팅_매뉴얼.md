# 1. 개요

- 프로젝트명: RUNNITY (실시간 러닝 챌린지 플랫폼)
- 구조:
  - Infra 서버(EC2): Jenkins, Nginx, 모니터링
  - Backend 서버(2대 EC2): Spring Boot API 서버
  - WebSocket 서버(2대 EC2): 실시간 러닝 방 WebSocket 서버
  - AI 서버(EC2): Kafka 기반 하이라이트 생성 LLM 서버 (FastAPI/uvicorn)
  - 외부 Kafka/Redis 서버: SSAFY k13a703 메인 서버 사용
## 2. 사용 기술 및 버전

### 공통
- OS: Ubuntu 24.04 LTS (EC2)
- Git: 2.47.3
- Docker: 28.2.2
- docker compose: v2 (도커 내장 compose)
- GitLab: SSAFY GitLab

### Backend 서버
- JVM: OpenJDK 17
- Framework: Spring Boot 3.5.7
- 빌드 도구: Gradle 8.14.3
- DB: MySQL 8.0
- Cache/Message: Redis 7 (cache, pubsub)
- Kafka: confluentinc/cp-kafka:7.6.1, Zookeeper 7.6.1

### WebSocket 서버
- Spring Boot 3.5.7 (WebSocket)
- MySQL / Redis / Kafka 동일 사용

### AI 서버
- Python: 3.11
- Web Framework: FastAPI + Uvicorn
- 패키지 관리: pip, requirements.txt

### Infra / Web
- Web Server: Nginx 1.24.0 (reverse proxy, SSL)
- Jenkins: jenkins/jenkins:lts-jdk17 (Docker 컨테이너)
- 인증서: Let’s Encrypt (도메인: runnity.p-e.kr)
- IDE:
  - IntelliJ IDEA 2024.x (Backend, WebSocket)
  - VSCode (AI 서버, 인프라 스크립트)
## 2. 사용 기술 및 버전

### 공통
- OS: Ubuntu 24.04 LTS (EC2)
- Git: 2.47.3
- Docker: 28.2.2
- docker compose: v2 (도커 내장 compose)
- GitLab: SSAFY GitLab


## 3. GitLab 소스 클론

```bash
git clone https://lab.ssafy.com/s13-final/S13P31A703.git
cd S13P31A703

# 백엔드/웹소켓: backend 브랜치
git checkout backend

# AI 서버: ai 브랜치
git checkout ai
```
#### 4. 주요 환경 변수 (Backend/WebSocket 공통)

| 이름                      | 예시 값                                                                                           | 설명                       | 비고               |
| ----------------------- | ---------------------------------------------------------------------------------------------- | ------------------------ | ---------------- |
| SPRING_PROFILES_ACTIVE  | prod                                                                                           | 실행 profile               |                  |
| SERVER_PORT             | 8080                                                                                           | Spring Boot 서버 포트        |                  |
| WEBSOCKET_SERVER_PORT   | 8081                                                                                           | WebSocket 별도 서버 포트       |                  |
| TZ                      | Asia/Seoul                                                                                     | 서버 타임존                   |                  |
| DB_HOST                 | 13.209.89.196                                                                                  | MySQL 호스트                | 운영 시 Secret 관리   |
| DB_PORT                 | 3306                                                                                           | MySQL 포트                 |                  |
| DB_NAME                 | runnity                                                                                        | DB 이름                    |                  |
| DB_USER                 | ssafy                                                                                          | DB 계정                    |                  |
| DB_PASSWORD             | ********                                                                                       | DB 비밀번호                  | 마스킹              |
| REDIS_HOST              | k13a703.p.ssafy.io                                                                             | Redis 단일 호스트             | Cache/ PubSub 통합 |
| REDIS_CACHE_HOST        | k13a703.p.ssafy.io                                                                             | Redis cache host         |                  |
| REDIS_CACHE_PORT        | 6379                                                                                           | Redis cache port         |                  |
| REDIS_PUBSUB_HOST       | k13a703.p.ssafy.io                                                                             | Redis pubsub host        |                  |
| REDIS_PUBSUB_PORT       | 6380                                                                                           | Redis pubsub port        |                  |
| KAFKA_BOOTSTRAP_SERVERS | k13a703.p.ssafy.io:29092                                                                       | Kafka bootstrap 서버       | 기존 필드            |
| KAFKA_BOOTSTRAP         | k13a703.p.ssafy.io:29092                                                                       | Kafka bootstrap 서버 (대체명) |                  |
| AWS_BUCKET              | runnity-s3-bucket                                                                              | S3 버킷명                   |                  |
| AWS_REGION              | ap-northeast-2                                                                                 | S3 리전                    |                  |
| AWS_ACCESS_KEY          | ********                                                                                       | AWS Access Key           | 마스킹              |
| AWS_SECRET_KEY          | ********                                                                                       | AWS Secret Key           | 마스킹              |
| AWS_STATIC              | ap-northeast-2                                                                                 | 정적 리전                    |                  |
| JWT_SECRET              | ****************                                                                               | JWT 서명 키                 | 매우 민감 정보         |
| GOOGLE_CLIENT_ID        | ****************                                                                               | Google OAuth Client ID   | 마스킹              |
| KAKAO_CLIENT_ID         | ***************                                                                                | 카카오 REST API Key         | 마스킹              |
| KAKAO_ISS               | [https://kauth.kakao.com](https://kauth.kakao.com)                                             | Kakao OIDC Issuer        |                  |
| KAKAO_JWKS_URI          | [https://kauth.kakao.com/.well-known/jwks.json](https://kauth.kakao.com/.well-known/jwks.json) | JWKS URI                 |                  |
| STREAM_SERVER_URL       | [http://43.203.250.119:8080](http://43.203.250.119:8080)                                       | Stream 서버 URL            |                  |
| FIREBASE_KEY_PATH       | fcmservice-account-key.json                                                                    | Firebase 서비스키 경로         |                  |
| WEBSOCKET_SERVER_URL_0  | wss://runnity.p-e.kr/ws/13.125.163.87                                                          | WebSocket 서버 0 URL       |                  |
| WEBSOCKET_SERVER_URL_1  | wss://runnity.p-e.kr/ws/43.203.217.82                                                          | WebSocket 서버 1 URL       |                  |
| WEBSOCKET_SERVER_ID     | 43.203.217.82                                                                                  | 현재 서버 인스턴스 ID            |                  |
| WEBSOCKET_SERVER_URL    | wss://runnity.p-e.kr/ws/43.203.217.82                                                          | 현재 서버 WS URL             |                  |


## 5. 운영 배포 절차

### 5-1. Infra 서버(Jenkins) 설정

- Jenkins 컨테이너 내 작업 디렉토리:
  - Backend: `/var/jenkins_home/workspace/backend-server-CICD`
  - Stream/WebSocket: `/var/jenkins_home/workspace/stream-server-CICD`
  - AI: `/var/jenkins_home/workspace/AI-server-CICD`

- Jenkins Job 목록:
  - `backend-server-CICD` : backend 브랜치 Docker 빌드 & 2대 EC2 배포
  - `stream-server-CICD` : stream 서버 Docker 빌드 & EC2 배포
  - `AI-server-CICD` : ai 브랜치 LLM 서버 Docker 빌드 & EC2 배포
  - `websocket-server-CICD` : WebSocket 서버 Docker 빌드 & 2대 EC2 배포
- 각 Job의 Jenkinsfile 경로:
  - Backend: `backend/Jenkinsfile`
  - stream: `backend/stream/Jenkinsfile`
  - AI: `backend/ai/Jenkinsfile`
  - WebSocket: `backend/websocket-backend/Jenkinsfile`

### 5-2. 배포 순서

1. Kafka/Redis/DB 서버(k13a703.p.ssafy.io) 실행 상태 확인
2. Backend 서버 EC2 두 대 기동
3. WebSocket 서버 EC2 두 대 기동 
4. AI 서버 EC2 기동
5. Jenkins 대시보드에서 다음 Job 순서대로 실행
   1) backend-server-CICD
   2) stream-server-CICD
   3) AI-server-CICD
6. Nginx 리버스 프록시/도메인 확인: `https://runnity.p-e.kr`
## 6. 배포 시 특이사항

1. Nginx 설정
   - 설정 파일: `/etc/nginx/sites-available/backend.conf`
   - 주요 역할:
     - `/api/**` → Backend 서버 2대 upstream 로드밸런싱
     - `/ws/**` → WebSocket 서버로 WebSocket proxy_pass
     - SSL Termination (Let’s Encrypt 인증서 사용)

2. WebSocket
   - 클라이언트 연결 엔드포인트:
     - `wss://runnity.p-e.kr/ws/{serverId}?ticket={티켓값}`
   - 서버 ID 예:
     - `13.125.163.87` 등
   - 티켓 검증은 Spring HandshakeInterceptor 에서 수행.

3. AI 서버
   - Kafka 토픽: `highlight-event`
   - Consumer 그룹: `runnity-llm-consumer`
   - Google TTS key 파일: `google-tts-key.json`은 Git에 올리지 않고
     - AI 서버 EC2 `~/llm-app/google-tts-key.json`에만 존재해야 함
     - Docker 컨테이너에 volume mount로 주입
## 7. DB 접속 정보 및 프로퍼티 파일 목록

### 7-1. DB 기본 정보

- DBMS: MySQL 8.0
- Host: k13a703.p.ssafy.io
- Port: 3306
- DB Name: runnity
- User: ssafy
- Password: ****



### 7-2. DB 관련 설정 파일 목록

- `backend/runnity/src/main/resources/application.yml`
- `backend/runnity/src/main/resources/application-prod.yml`
- `backend/stream/src/main/resources/application.yml` (WebSocket 서버)
- Docker 환경 변수:
  - Backend: `.env` (backend 디렉토리)
  - WebSocket 서버: `.env.stream` (예)
  - AI 서버: `.env.ai` (AI 서버 EC2 `~/llm-app/.env.ai`)

## 프론트 포팅 메뉴얼
###  빌드 & 실행 방법
    

#### Android (폰 앱)  
로컬 실행

1.  Android Studio에서 app 모듈을 Run Configuration으로 선택
    
2.  안드로이드 폰 또는 에뮬레이터를 선택 후 실행
    
3.  최초 실행 시 요청되는 권한
    
    *   위치 권한(정확한 위치 / 대략적 위치)
        
    *   알림 권한(Android 13+)
        
    *   활동 인식/센서 권한(필요 시)
        

릴리즈 빌드

1.  Android Studio 메뉴  
    Build → Generate App Bundles or APKs → Generate APKs
    

5-2. Wear OS (워치 앱)  
로컬 실행

1.  Wear OS 에뮬레이터를 생성하거나 실제 워치 기기를 Android Studio에 연결
    
2.  Run Configuration에서 wear 모듈을 선택해 실행
    

폰과 워치 페어링

*   스마트폰에 Wear OS 앱 설치
    
*   워치를 폰과 페어링
    
*   이후 Runnity 워치 앱을 설치해 데이터 동기화 테스트 진행
    